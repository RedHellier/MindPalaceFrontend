name: Cypress E2E on PR
on:
  pull_request:
  workflow_dispatch:
jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout frontend repo
        uses: actions/checkout@v3
        
      - name: Checkout backend repo
        uses: actions/checkout@v3
        with:
          repository: fac-31/Pro0428-MindPalaceBackend
          path: backend
          
      - name: Generate backend .env file
        run: |
          cd backend
          echo OPENAI_KEY=${{ secrets.OPENAI_KEY }} >> .env
          echo SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} >> .env
          echo PORT=5000 >> .env
          
      - name: Start backend
        run: |
          cd backend
          docker compose up -d
          
      - name: Install frontend dependencies
        run: npm ci
        
      - name: Install wait-on
        run: npm install -g wait-on
        
      - name: Start frontend server
        run: npm start &
        
      - name: Wait for servers to be ready
        run: |
          wait-on http://localhost:5000 --timeout 60000
          wait-on http://localhost:3000 --timeout 60000
        
      - name: Run Cypress tests
        run: npx cypress run
        env:
          CYPRESS_baseUrl: http://localhost:3000

name: Cypress E2E on PR

on:
  pull_request:
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout frontend repo
        uses: actions/checkout@v3
        
      - name: Checkout backend repo
        uses: actions/checkout@v3
        with:
          repository: fac-31/Pro0428-MindPalaceBackend
          path: backend
          
      - name: Generate backend .env file
        run: |
          echo "OPENAI_KEY=${{ secrets.OPENAI_KEY }}" >> backend/.env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> backend/.env
          echo "PORT=5000" >> backend/.env

      - name: Build frontend dependencies
        run: npm ci

      - name: Build & start full stack using docker-compose
        run: |
          docker compose -f docker-compose.ci.yml up -d --build

      - name: Wait for backend to be ready
        run: |
          docker run --network container:$(docker ps -qf name=frontend) appropriate/curl -f http://backend:5000

      - name: Wait for frontend to be ready
        run: |
          docker run --network container:$(docker ps -qf name=frontend) appropriate/curl -f http://frontend:3000

      - name: Run Cypress tests
        run: npx cypress run
        env:
          CYPRESS_baseUrl: http://localhost:3000
